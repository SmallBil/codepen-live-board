{"version":3,"sources":["index.ts"],"names":[],"mappings":"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","file":"src.77de5100.map","sourceRoot":"../src","sourcesContent":["let participants = [];\n(async () => {\n  const resp = await fetch('/api/participants');\n  participants = await resp.json();\n  renderParticipants(participants);\n})();\n\nfunction url(s) {\n  var l = window.location;\n  return ((l.protocol === \"https:\") ? \"wss://\" : \"ws://\") + l.hostname + (((l.port != 80) && (l.port != 443)) ? \":\" + l.port : \"\") + l.pathname + s;\n}\nconst WS_URL = url('');\n\nfunction start(websocketServerLocation: string) {\n  const ws = new WebSocket(websocketServerLocation);\n  ws.onmessage = (event) => {\n    participants = updateParticipants(participants, JSON.parse(event.data));\n    renderParticipants(participants);\n  };\n  ws.onclose = () => {\n    setTimeout(() => start(websocketServerLocation), 5000);\n  };\n}\n\nstart(WS_URL);\n\n\nfunction updateParticipants(participants, participant) {\n  const idx = participants.findIndex( ({ penUrl }) => penUrl === participant.penUrl)\n  if (idx === -1) {\n    return [...participants, participant];\n  } else {\n    const copy = participants.slice(0);\n    copy.splice(idx, 1, participant);\n    return copy;\n  }\n}\n\nfunction renderParticipants(participants) {\n  console.log(participants);\n  const container = document.querySelector('#frames-grid');\n  const blocks = Array.from(document.querySelectorAll('.participant'));\n  participants.forEach(p => {\n    const block = blocks.find(block => block.id === p.penUrl);\n    const newBlock = htmlToElement(`\n      <div class=\"participant\" id=\"${p.penUrl}\" data-hash=\"${p.lastHash}\">\n        <p><a target=\"_blank\" href=\"${p.penUrl}\">${p.name}: <span class=\"change-count\">${p.changeCount}</span></a></p>\n        <iframe src=\"/fetch?url=${p.fullpageUrl}\"></iframe>\n      </div>`\n      );\n    if (block) {\n      // TODO: don't touch if hash is the same\n      if (block.dataset.hash !== p.lastHash) {\n        container.insertBefore(newBlock, block);\n        container.removeChild(block);\n      }\n    } else {\n      container.appendChild(newBlock);\n    }\n  })\n}\n\nfunction htmlToElement(html) {\n  var template = document.createElement('template');\n  html = html.trim(); // Never return a text node of whitespace as the result\n  template.innerHTML = html;\n  return template.content.firstChild;\n}\n\ndocument\n  .querySelector('.registration-form')\n  .addEventListener('submit', formSubmit);\n\nfunction formSubmit(e) {\n  e.preventDefault();\n  const errMsgElt = document.querySelector('.registration-error');\n  const okMsgElt = document.querySelector('.registration-ok')\n  const form = e.target;\n  fetch('/register', {\n    method: 'POST',\n    headers: {\n      'Content-Type': 'application/json',\n      'Accept': 'application/json'\n    },\n    body: JSON.stringify({\n      participantName: form.participantName.value,\n      penUrl: form.penUrl.value\n    })\n  })\n  .then(resp => resp.json())\n  .then((json) => {\n    if (json.error) {\n      errMsgElt.style.display = 'initial';\n      okMsgElt.style.display = 'none';\n      errMsgElt.innerHTML = json.error;\n      // document.querySelector('.registration-ok').style.display = 'initial';\n    } else {\n      form.reset();\n      errMsgElt.style.display = 'none';\n      okMsgElt.style.display = 'initial';\n    }\n  });\n}"]}